index="azure" sourcetype="azure:aad:signin"
| stats count by _time, user, action
| streamstats global=true count current=false by user, action
| streamstats global=true current=false last(count) as last_count last(action) as last_action by user
| eval failure_threshold = 25
| eval is_failure_stretch = if(last_action="failure" AND action="failure", 1, 0)
| eval is_success_after_failures = if(action="success" AND last_count >= failure_threshold, 1, 0)
| streamstats sum(is_failure_stretch) as failure_stretch_count by user
| streamstats sum(is_success_after_failures) as success_marker by user
| search success_marker=1 AND action="success"
| eval failure_count = failure_stretch_count + 1
| where failure_count >= failure_threshold
| dedup user
| fields - last_action, count, last_count, failure_stretch_count, success_marker
| table _time, user, action, failure_count
